name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deploy to production'
        required: true
        type: choice
        options:
          - production
      confirmation:
        description: 'Type "DEPLOY" to confirm production deployment'
        required: true
        type: string

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PRODUCTION_PROJECT_ID }}
  GCP_REGION: us-central1
  SERVICE_NAME: dailyworker-production
  REGISTRY: gcr.io

jobs:
  # Validation and security checks
  validate:
    name: Pre-Deployment Validation
    runs-on: ubuntu-latest

    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirmation }}" != "DEPLOY" ]; then
            echo "‚ùå Deployment confirmation failed"
            echo "You must type 'DEPLOY' to confirm production deployment"
            exit 1
          fi
          echo "‚úÖ Deployment confirmed"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Security prerequisites check
        run: |
          echo "üîí Checking security prerequisites..."
          echo ""
          echo "CRITICAL: Ensure the following are configured before deploying:"
          echo "  ‚úì GCP API keys scoped and restricted"
          echo "  ‚úì Service accounts created with minimal permissions"
          echo "  ‚úì Secrets stored in GCP Secret Manager"
          echo "  ‚úì VPC and firewall rules configured"
          echo "  ‚úì Cloud SQL configured with private IP"
          echo "  ‚úì Cloud Armor enabled for DDoS protection"
          echo "  ‚úì Monitoring and alerting configured"
          echo "  ‚úì Backup and recovery tested"
          echo ""
          echo "See: projects/DWnews/plans/CLOUD_SECURITY_CONFIG.md"

          # Check for critical files
          if [ ! -f "projects/DWnews/plans/CLOUD_SECURITY_CONFIG.md" ]; then
            echo "‚ö†Ô∏è  Warning: Security configuration document not found"
          fi

      - name: Check for secrets in code
        run: |
          echo "üîç Scanning for hardcoded secrets..."
          if grep -r "sk-ant-\|sk-\|AAAA\|AIza" projects/DWnews/backend projects/DWnews/frontend --exclude-dir=node_modules --exclude-dir=.git || true; then
            echo "‚ùå Potential secrets found in code"
            exit 1
          fi
          echo "‚úÖ No secrets found in code"

  # Run full test suite
  tests:
    name: Full Test Suite
    needs: validate
    uses: ./.github/workflows/ci.yml
    secrets: inherit

  # Build Docker image
  build:
    name: Build Production Image
    runs-on: ubuntu-latest
    needs: tests
    outputs:
      image: ${{ steps.build-image.outputs.image }}
      tag: ${{ steps.build-image.outputs.tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PRODUCTION_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_PRODUCTION_SA_KEY }}
          export_default_credentials: true

      - name: Configure Docker for GCR
        run: |
          gcloud auth configure-docker gcr.io

      - name: Build and scan image
        id: build-image
        run: |
          # Generate semantic version tag
          VERSION_TAG="v$(date +%Y%m%d)-${GITHUB_SHA::8}"
          IMAGE_TAG="${REGISTRY}/${GCP_PROJECT_ID}/${SERVICE_NAME}:${VERSION_TAG}"
          LATEST_TAG="${REGISTRY}/${GCP_PROJECT_ID}/${SERVICE_NAME}:latest"

          echo "Building production image: ${IMAGE_TAG}"

          cd projects/DWnews

          # Use production Dockerfile (same as staging)
          cat > Dockerfile <<'EOF'
          FROM python:3.11-slim AS backend-builder
          WORKDIR /app
          RUN apt-get update && apt-get install -y gcc postgresql-client && rm -rf /var/lib/apt/lists/*
          COPY backend/requirements.txt .
          RUN pip install --no-cache-dir -r requirements.txt

          FROM node:20-alpine AS frontend-builder
          WORKDIR /app/frontend
          COPY frontend/package*.json ./
          RUN npm ci --only=production
          COPY frontend/ ./
          RUN npm run build || echo "No build script, using source files"

          FROM python:3.11-slim
          WORKDIR /app
          RUN apt-get update && apt-get install -y postgresql-client curl && rm -rf /var/lib/apt/lists/*
          RUN groupadd -r appuser && useradd -r -g appuser appuser

          COPY --from=backend-builder /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages
          COPY --from=backend-builder /usr/local/bin /usr/local/bin
          COPY --chown=appuser:appuser backend/ ./backend/
          COPY --chown=appuser:appuser database/ ./database/
          COPY --chown=appuser:appuser --from=frontend-builder /app/frontend ./frontend/

          ENV PYTHONUNBUFFERED=1
          ENV PORT=8080

          HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
            CMD curl -f http://localhost:8080/api/health || exit 1

          USER appuser
          EXPOSE 8080
          CMD ["uvicorn", "backend.main:app", "--host", "0.0.0.0", "--port", "8080", "--workers", "2"]
          EOF

          # Build with production optimizations
          docker build \
            --tag ${IMAGE_TAG} \
            --tag ${LATEST_TAG} \
            --build-arg ENVIRONMENT=production \
            .

          # Scan for vulnerabilities
          echo "üîç Scanning image for vulnerabilities..."
          gcloud container images describe ${IMAGE_TAG} || true

          # Push to registry
          docker push ${IMAGE_TAG}
          docker push ${LATEST_TAG}

          echo "image=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "tag=${VERSION_TAG}" >> $GITHUB_OUTPUT
          echo "‚úÖ Production image built: ${IMAGE_TAG}"

  # Create database backup before migration
  backup-database:
    name: Backup Production Database
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PRODUCTION_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_PRODUCTION_SA_KEY }}
          export_default_credentials: true

      - name: Create backup
        id: backup
        run: |
          echo "üíæ Creating production database backup..."
          BACKUP_ID="pre-deploy-$(date +%Y%m%d-%H%M%S)"

          gcloud sql backups create \
            --instance=${{ secrets.GCP_PRODUCTION_DB_INSTANCE }} \
            --description="Pre-deployment backup before ${GITHUB_SHA::8}"

          echo "backup_id=${BACKUP_ID}" >> $GITHUB_OUTPUT
          echo "‚úÖ Backup created: ${BACKUP_ID}"

  # Run database migrations with rollback capability
  migrate-database:
    name: Database Migrations
    runs-on: ubuntu-latest
    needs: backup-database

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PRODUCTION_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_PRODUCTION_SA_KEY }}
          export_default_credentials: true

      - name: Run migrations
        run: |
          echo "üîÑ Running production database migrations..."

          # Set up Cloud SQL Proxy
          wget https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64 -O cloud_sql_proxy
          chmod +x cloud_sql_proxy
          ./cloud_sql_proxy -instances=${{ secrets.GCP_PRODUCTION_DB_CONNECTION }}=tcp:5432 &
          sleep 5

          cd projects/DWnews
          pip install psycopg2-binary alembic

          # Run migrations
          if [ -f "database/migrations/migrate.py" ]; then
            python database/migrations/migrate.py
          else
            echo "‚ö†Ô∏è  No migration script found"
          fi

          echo "‚úÖ Migrations complete"
        env:
          DATABASE_URL: ${{ secrets.GCP_PRODUCTION_DATABASE_URL }}

  # Blue-Green deployment to Cloud Run
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, migrate-database]
    environment:
      name: production
      url: ${{ steps.deploy.outputs.service_url }}

    steps:
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PRODUCTION_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_PRODUCTION_SA_KEY }}
          export_default_credentials: true

      - name: Deploy new revision
        id: deploy
        run: |
          echo "üöÄ Deploying to production..."

          # Deploy with gradual rollout (no traffic initially)
          gcloud run deploy ${SERVICE_NAME} \
            --image=${{ needs.build.outputs.image }} \
            --platform=managed \
            --region=${GCP_REGION} \
            --allow-unauthenticated \
            --service-account=${{ secrets.GCP_PRODUCTION_SERVICE_ACCOUNT }} \
            --set-env-vars="ENVIRONMENT=production" \
            --set-secrets="CLAUDE_API_KEY=claude-api-key:latest,OPENAI_API_KEY=openai-api-key:latest,TWITTER_BEARER_TOKEN=twitter-bearer-token:latest,DATABASE_URL=database-url-production:latest" \
            --min-instances=1 \
            --max-instances=20 \
            --cpu=2 \
            --memory=1Gi \
            --timeout=300s \
            --concurrency=80 \
            --port=8080 \
            --no-traffic \
            --tag=${{ needs.build.outputs.tag }}

          # Get new revision name
          REVISION=$(gcloud run revisions list \
            --service=${SERVICE_NAME} \
            --platform=managed \
            --region=${GCP_REGION} \
            --format='value(name)' \
            --limit=1)

          echo "revision=${REVISION}" >> $GITHUB_OUTPUT

          # Get service URL
          SERVICE_URL=$(gcloud run services describe ${SERVICE_NAME} \
            --platform=managed \
            --region=${GCP_REGION} \
            --format='value(status.url)')

          echo "service_url=${SERVICE_URL}" >> $GITHUB_OUTPUT
          echo "‚úÖ New revision deployed (no traffic): ${REVISION}"

      - name: Test new revision
        run: |
          echo "üß™ Testing new revision..."
          REVISION_URL="https://${{ needs.build.outputs.tag }}---${SERVICE_NAME}-$(echo ${GCP_REGION} | tr -d '-')-${GCP_PROJECT_ID}.a.run.app"

          # Wait for revision to be ready
          sleep 15

          # Health check
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" ${REVISION_URL}/api/health || echo "000")

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "‚úÖ New revision health check passed"
          else
            echo "‚ùå New revision health check failed (HTTP $HTTP_CODE)"
            echo "Rolling back..."
            exit 1
          fi

          # Smoke tests
          curl -f ${REVISION_URL}/ || exit 1
          curl -f ${REVISION_URL}/api/articles/ || exit 1

          echo "‚úÖ New revision tests passed"

      - name: Gradual traffic migration
        run: |
          echo "üîÑ Starting gradual traffic migration..."
          REVISION="${{ steps.deploy.outputs.revision }}"

          # 10% traffic
          echo "Routing 10% traffic to new revision..."
          gcloud run services update-traffic ${SERVICE_NAME} \
            --to-revisions=${REVISION}=10 \
            --platform=managed \
            --region=${GCP_REGION}
          sleep 60

          # 50% traffic
          echo "Routing 50% traffic to new revision..."
          gcloud run services update-traffic ${SERVICE_NAME} \
            --to-revisions=${REVISION}=50 \
            --platform=managed \
            --region=${GCP_REGION}
          sleep 120

          # 100% traffic
          echo "Routing 100% traffic to new revision..."
          gcloud run services update-traffic ${SERVICE_NAME} \
            --to-revisions=${REVISION}=100 \
            --platform=managed \
            --region=${GCP_REGION}

          echo "‚úÖ Traffic migration complete"

      - name: Monitor deployment
        run: |
          echo "üìä Monitoring deployment for 5 minutes..."
          SERVICE_URL="${{ steps.deploy.outputs.service_url }}"

          for i in {1..10}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" ${SERVICE_URL}/api/health)
            if [ "$HTTP_CODE" -ne 200 ]; then
              echo "‚ùå Health check failed (HTTP $HTTP_CODE) - Rolling back!"

              # Rollback to previous revision
              PREVIOUS_REVISION=$(gcloud run revisions list \
                --service=${SERVICE_NAME} \
                --platform=managed \
                --region=${GCP_REGION} \
                --format='value(name)' \
                --limit=2 | tail -n 1)

              gcloud run services update-traffic ${SERVICE_NAME} \
                --to-revisions=${PREVIOUS_REVISION}=100 \
                --platform=managed \
                --region=${GCP_REGION}

              exit 1
            fi
            echo "Health check $i/10: OK"
            sleep 30
          done

          echo "‚úÖ Deployment stable"

      - name: Deployment summary
        run: |
          echo "## üéâ Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service URL:** ${{ steps.deploy.outputs.service_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ needs.build.outputs.image }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.build.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Revision:** ${{ steps.deploy.outputs.revision }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Steps" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Security validation passed" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ All tests passed" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Database backed up" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Migrations completed" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ New revision deployed" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Gradual traffic migration (10% ‚Üí 50% ‚Üí 100%)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Deployment monitoring complete" >> $GITHUB_STEP_SUMMARY

  # Post-deployment verification
  verify:
    name: Post-Deployment Verification
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Run production smoke tests
        run: |
          echo "üß™ Running production smoke tests..."
          SERVICE_URL="${{ needs.deploy.outputs.service_url }}"

          # Test critical endpoints
          curl -f ${SERVICE_URL}/ || exit 1
          curl -f ${SERVICE_URL}/api/health || exit 1
          curl -f ${SERVICE_URL}/api/articles/ || exit 1
          curl -f ${SERVICE_URL}/api/articles/published || exit 1

          echo "‚úÖ All smoke tests passed"

      - name: Check error rates
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PRODUCTION_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_PRODUCTION_SA_KEY }}
          export_default_credentials: true

      - name: Query logs for errors
        run: |
          echo "üìä Checking error rates..."

          # Query recent logs for errors
          gcloud logging read \
            "resource.type=cloud_run_revision AND severity>=ERROR" \
            --limit=10 \
            --format=json \
            --freshness=5m || echo "No recent errors found"

  # Rollback workflow (can be triggered manually if needed)
  rollback:
    name: Rollback (Manual Only)
    runs-on: ubuntu-latest
    if: failure()
    needs: [deploy, verify]

    steps:
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PRODUCTION_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_PRODUCTION_SA_KEY }}
          export_default_credentials: true

      - name: Rollback to previous revision
        run: |
          echo "‚èÆÔ∏è  Rolling back to previous revision..."

          PREVIOUS_REVISION=$(gcloud run revisions list \
            --service=${SERVICE_NAME} \
            --platform=managed \
            --region=${GCP_REGION} \
            --format='value(name)' \
            --limit=2 | tail -n 1)

          gcloud run services update-traffic ${SERVICE_NAME} \
            --to-revisions=${PREVIOUS_REVISION}=100 \
            --platform=managed \
            --region=${GCP_REGION}

          echo "‚úÖ Rolled back to: ${PREVIOUS_REVISION}"

      - name: Create rollback issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Production deployment rolled back: ${context.sha.substring(0, 8)}`,
              body: `Production deployment failed and was rolled back.\n\nCommit: ${context.sha}\n\nCheck the [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details.`,
              labels: ['deployment', 'production', 'rollback', 'urgent']
            });
