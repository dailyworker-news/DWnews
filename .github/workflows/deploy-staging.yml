name: Deploy to Staging

on:
  push:
    branches:
      - develop
    paths:
      - 'projects/DWnews/backend/**'
      - 'projects/DWnews/frontend/**'
      - 'projects/DWnews/database/**'
      - '.github/workflows/deploy-staging.yml'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if tests fail'
        required: false
        type: boolean
        default: false

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_STAGING_PROJECT_ID }}
  GCP_REGION: us-central1
  SERVICE_NAME: dailyworker-staging
  REGISTRY: gcr.io

jobs:
  # Prerequisites check
  security-check:
    name: Security Prerequisites
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for secrets in code
        run: |
          echo "ðŸ” Scanning for hardcoded secrets..."
          if grep -r "sk-ant-\|sk-\|AAAA\|AIza" projects/DWnews/backend projects/DWnews/frontend --exclude-dir=node_modules --exclude-dir=.git || true; then
            echo "âš ï¸  Warning: Potential secrets found in code"
            echo "Please ensure all secrets are in GCP Secret Manager"
          fi

      - name: Verify .env files not committed
        run: |
          if find . -name ".env.local" -o -name ".env" | grep .; then
            echo "âŒ .env files found in repository"
            exit 1
          fi
          echo "âœ… No .env files committed"

  # Run tests before deployment
  tests:
    name: Run All Tests
    needs: security-check
    uses: ./.github/workflows/ci.yml
    secrets: inherit

  # Build and push Docker image
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [security-check, tests]
    if: always() && (needs.tests.result == 'success' || github.event.inputs.force_deploy == 'true')
    outputs:
      image: ${{ steps.build-image.outputs.image }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_STAGING_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_STAGING_SA_KEY }}
          export_default_credentials: true

      - name: Configure Docker for GCR
        run: |
          gcloud auth configure-docker gcr.io

      - name: Build Docker image
        id: build-image
        run: |
          IMAGE_TAG="${REGISTRY}/${GCP_PROJECT_ID}/${SERVICE_NAME}:${GITHUB_SHA::8}"
          echo "Building image: ${IMAGE_TAG}"

          cd projects/DWnews

          # Create production Dockerfile
          cat > Dockerfile <<'EOF'
          # Multi-stage build for smaller image
          FROM python:3.11-slim AS backend-builder

          WORKDIR /app

          # Install system dependencies
          RUN apt-get update && apt-get install -y \
              gcc \
              postgresql-client \
              && rm -rf /var/lib/apt/lists/*

          # Install Python dependencies
          COPY backend/requirements.txt .
          RUN pip install --no-cache-dir -r requirements.txt

          # Frontend build stage
          FROM node:20-alpine AS frontend-builder

          WORKDIR /app/frontend
          COPY frontend/package*.json ./
          RUN npm ci --only=production

          COPY frontend/ ./
          RUN npm run build || echo "No build script, using source files"

          # Final production image
          FROM python:3.11-slim

          WORKDIR /app

          # Install runtime dependencies
          RUN apt-get update && apt-get install -y \
              postgresql-client \
              curl \
              && rm -rf /var/lib/apt/lists/*

          # Create non-root user
          RUN groupadd -r appuser && useradd -r -g appuser appuser

          # Copy Python dependencies from builder
          COPY --from=backend-builder /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages
          COPY --from=backend-builder /usr/local/bin /usr/local/bin

          # Copy application code
          COPY --chown=appuser:appuser backend/ ./backend/
          COPY --chown=appuser:appuser database/ ./database/
          COPY --chown=appuser:appuser --from=frontend-builder /app/frontend ./frontend/

          # Set environment
          ENV PYTHONUNBUFFERED=1
          ENV PORT=8080

          # Health check
          HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
            CMD curl -f http://localhost:8080/api/health || exit 1

          # Switch to non-root user
          USER appuser

          # Expose port
          EXPOSE 8080

          # Start application
          CMD ["uvicorn", "backend.main:app", "--host", "0.0.0.0", "--port", "8080"]
          EOF

          # Build image
          docker build -t ${IMAGE_TAG} .

          # Push to GCR
          docker push ${IMAGE_TAG}

          echo "image=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "âœ… Image built and pushed: ${IMAGE_TAG}"

      - name: Scan image for vulnerabilities
        run: |
          echo "ðŸ” Scanning image for vulnerabilities..."
          gcloud container images describe ${{ steps.build-image.outputs.image }} || true
          # Note: Enable Container Scanning in GCP for automatic vulnerability detection

  # Database migrations
  migrate-database:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_STAGING_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_STAGING_SA_KEY }}
          export_default_credentials: true

      - name: Set up Cloud SQL Proxy
        run: |
          wget https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64 -O cloud_sql_proxy
          chmod +x cloud_sql_proxy
          ./cloud_sql_proxy -instances=${{ secrets.GCP_STAGING_DB_CONNECTION }}=tcp:5432 &
          sleep 5

      - name: Run migrations
        run: |
          echo "ðŸ”„ Running database migrations..."
          cd projects/DWnews

          # Install dependencies
          pip install psycopg2-binary alembic

          # Run migrations (if using Alembic)
          # alembic upgrade head

          # Or run custom migration script
          if [ -f "database/migrations/migrate.py" ]; then
            python database/migrations/migrate.py
          else
            echo "âš ï¸  No migration script found - skipping"
          fi

          echo "âœ… Migrations complete"
        env:
          DATABASE_URL: ${{ secrets.GCP_STAGING_DATABASE_URL }}

  # Deploy to Cloud Run
  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: [build, migrate-database]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_STAGING_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_STAGING_SA_KEY }}
          export_default_credentials: true

      - name: Deploy to Cloud Run
        id: deploy
        run: |
          echo "ðŸš€ Deploying to Cloud Run..."

          gcloud run deploy ${SERVICE_NAME} \
            --image=${{ needs.build.outputs.image }} \
            --platform=managed \
            --region=${GCP_REGION} \
            --allow-unauthenticated \
            --service-account=${{ secrets.GCP_STAGING_SERVICE_ACCOUNT }} \
            --set-env-vars="ENVIRONMENT=staging" \
            --set-secrets="CLAUDE_API_KEY=claude-api-key:latest,OPENAI_API_KEY=openai-api-key:latest,DATABASE_URL=database-url-staging:latest" \
            --min-instances=0 \
            --max-instances=10 \
            --cpu=1 \
            --memory=512Mi \
            --timeout=300s \
            --concurrency=80 \
            --port=8080 \
            --tag=${GITHUB_SHA::8}

          # Get service URL
          SERVICE_URL=$(gcloud run services describe ${SERVICE_NAME} \
            --platform=managed \
            --region=${GCP_REGION} \
            --format='value(status.url)')

          echo "service_url=${SERVICE_URL}" >> $GITHUB_OUTPUT
          echo "âœ… Deployed to: ${SERVICE_URL}"

      - name: Health check
        run: |
          echo "ðŸ¥ Running health check..."
          SERVICE_URL="${{ steps.deploy.outputs.service_url }}"

          # Wait for service to be ready
          sleep 10

          # Health check
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" ${SERVICE_URL}/api/health)

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… Health check passed (HTTP $HTTP_CODE)"
          else
            echo "âŒ Health check failed (HTTP $HTTP_CODE)"
            exit 1
          fi

      - name: Smoke tests
        run: |
          echo "ðŸ§ª Running smoke tests..."
          SERVICE_URL="${{ steps.deploy.outputs.service_url }}"

          # Test root endpoint
          curl -f ${SERVICE_URL}/ || exit 1

          # Test articles endpoint
          curl -f ${SERVICE_URL}/api/articles/ || exit 1

          echo "âœ… Smoke tests passed"

      - name: Deployment summary
        run: |
          echo "## ðŸŽ‰ Staging Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service URL:** ${{ steps.deploy.outputs.service_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ needs.build.outputs.image }}" >> $GITHUB_STEP_SUMMARY
          echo "**Git SHA:** ${GITHUB_SHA::8}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Homepage](${{ steps.deploy.outputs.service_url }})" >> $GITHUB_STEP_SUMMARY
          echo "- [API Health](${{ steps.deploy.outputs.service_url }}/api/health)" >> $GITHUB_STEP_SUMMARY
          echo "- [Admin Panel](${{ steps.deploy.outputs.service_url }}/admin/)" >> $GITHUB_STEP_SUMMARY

  # Notify on failure
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [deploy]
    if: failure()

    steps:
      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Staging deployment failed: ${context.sha.substring(0, 8)}`,
              body: `Staging deployment failed for commit ${context.sha}.\n\nCheck the [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details.`,
              labels: ['deployment', 'staging', 'failure']
            });
